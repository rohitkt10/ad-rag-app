name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches: [master]
    types: 
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - uses: actions/checkout@v4

    # 1. Authenticate to Google Cloud
    # You MUST add 'GCP_SA_KEY' (Service Account JSON) to your GitHub Repository Secrets
    - id: 'auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: "${{ secrets.GCP_SA_KEY }}"

    # 2. Set up gcloud CLI
    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'

    # 3. Build and Push Image (Cloud Build)
    - name: 'Build Container Image'
      run: |
        gcloud builds submit --quiet \
          --region=us-central1 \
          --tag us-central1-docker.pkg.dev/acquired-muse-484115-j8/ad-rag-repo/ad-rag-api:latest .

    # 4. Deploy to Cloud Run
    # Note: We only specify the image and region. Cloud Run preserves all other config 
    # (env vars, memory, secrets) from the previous successful deployment.
    - name: 'Deploy to Cloud Run'
      run: |
        gcloud run deploy ad-rag-api --quiet \
          --image=us-central1-docker.pkg.dev/acquired-muse-484115-j8/ad-rag-repo/ad-rag-api:latest \
          --region=us-central1
